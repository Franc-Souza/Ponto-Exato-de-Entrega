<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ponto Exato â€“ Entregas</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#0d47a1;color:#fff;padding:10px;text-align:center}
#map{height:55vh}
.controls{padding:8px;display:flex;flex-wrap:wrap;gap:6px}
button,select{
  padding:10px;font-size:14px;border:none;border-radius:8px
}
.btn{background:#1976d2;color:#fff}
.btn.green{background:#2e7d32}
.btn.orange{background:#ef6c00}
.btn.gray{background:#616161}
.entregas{background:#fff;max-height:30vh;overflow:auto;padding:8px}
.entrega{border-bottom:1px solid #ddd;padding:6px;font-size:13px}
.entrega.entregue{text-decoration:line-through;color:green}
</style>
</head>

<body>

<header>ğŸ“¦ Ponto Exato â€“ Rota de Entregas</header>

<div id="map"></div>

<div class="controls">
  <button class="btn" onclick="adicionarEntrega()">ğŸ“ Add</button>
  <button class="btn" onclick="buscarEndereco()">ğŸ” Buscar</button>
  <button class="btn green" onclick="proximaEntrega()">ğŸšš PrÃ³xima</button>
  <button class="btn" onclick="ativarGPS()">ğŸ“¡ GPS</button>
  <button class="btn gray" onclick="limparTudo()">ğŸ—‘ Limpar</button>
</div>

<div class="entregas" id="lista"></div>
<script>
  /* ====== BLOQUEIO POR DISPOSITIVO ====== */
  
  // gera ou recupera ID Ãºnico do dispositivo
  function getDeviceId(){
    let id = localStorage.getItem("device_id");
    if(!id){
      id = 'dev-' + Math.random().toString(36).substr(2,9);
      localStorage.setItem("device_id", id);
    }
    return id;
  }
  
  // lista de dispositivos liberados (VOCÃŠ edita)
  const DISPOSITIVOS_LIBERADOS = ["dev-urwizxgom"
    // EXEMPLO:
    // "dev-ab123cd45"
  ];
  
  // verifica acesso
  (function verificarAcesso(){
    const id = getDeviceId();
  
    if(!DISPOSITIVOS_LIBERADOS.includes(id)){
      document.body.innerHTML = `
        <div style="
          height:100vh;
          display:flex;
          flex-direction:column;
          align-items:center;
          justify-content:center;
          font-family:Arial;
          text-align:center;
          background:#f2f2f2;
        ">
          <h2>ğŸ”’ Acesso bloqueado</h2>
          <p>Este aplicativo estÃ¡ vinculado a um Ãºnico dispositivo.</p>
          <p><strong>ID do dispositivo:</strong><br>${id}</p>
          <p>Envie este cÃ³digo para liberaÃ§Ã£o.</p>
        </div>
      `;
      throw new Error("Dispositivo nÃ£o autorizado");
    }
  })();
  </script>
  
<script>
/* ================= CONFIG ================= */
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImU3ZGJlNTI2MDgwMTRiZmZiYzFlOTBmMzJkZmIxNmRiIiwiaCI6Im11cm11cjY0In0=";

/* ================= MAPA ================= */
const map = L.map('map').setView([-15.7801,-47.9292],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© OpenStreetMap'
}).addTo(map);

/* ================= ESTADO ================= */
let entregas = JSON.parse(localStorage.getItem('entregas')) || [];
let rotaLinha = null;
let gpsMarker = null;

/* ================= VOZ ================= */
function falar(txt){
  if(!('speechSynthesis' in window)) return;
  const m = new SpeechSynthesisUtterance(txt);
  m.lang = 'pt-BR';
  speechSynthesis.cancel();
  speechSynthesis.speak(m);
}

/* ================= PERSISTÃŠNCIA ================= */
function salvar(){
  localStorage.setItem('entregas',JSON.stringify(entregas));
}

/* ================= MARKERS ================= */
function criarMarker(e){
  e.marker = L.marker(e.latlng).addTo(map);
}

/* ================= LISTA ================= */
function atualizarLista(){
  const div = document.getElementById('lista');
  div.innerHTML='';
  entregas.forEach((e,i)=>{
    const d=document.createElement('div');
    d.className='entrega '+(e.status==='entregue'?'entregue':'');
    d.innerHTML=`
      ${i+1}. ${e.nome}<br>
      <button onclick="entregar(${i})">âœ…</button>
      <button onclick="apagar(${i})">ğŸ—‘</button>
    `;
    div.appendChild(d);
  });
}

/* ================= ADD ENTREGA ================= */
function adicionarEntrega(){
  alert('Clique no mapa');
  map.once('click',e=>{
    const nome = prompt('DescriÃ§Ã£o da entrega');
    if(!nome) return;
    const ent = {nome,latlng:e.latlng,status:'pendente'};
    entregas.push(ent);
    criarMarker(ent);
    salvar();
    atualizarLista();
  });
}

/* ================= BUSCAR ================= */
async function buscarEndereco(){
  const q = prompt('Digite endereÃ§o ou CEP');
  if(!q) return;

  let url = q.replace(/\D/g,'').length===8
    ? `https://viacep.com.br/ws/${q}/json/`
    : `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;

  const r = await fetch(url);
  const d = await r.json();

  let texto = q;
  if(d.logradouro){
    texto = `${d.logradouro}, ${d.localidade}-${d.uf}`;
  }

  const geo = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(texto)}`
  ).then(r=>r.json());

  if(!geo.length) return alert('NÃ£o encontrado');

  const latlng=[+geo[0].lat,+geo[0].lon];
  map.setView(latlng,18);

  if(confirm('Adicionar entrega aqui?')){
    const ent={nome:texto,latlng,status:'pendente'};
    entregas.push(ent);
    criarMarker(ent);
    salvar();
    atualizarLista();
  }
}

/* ================= GPS ================= */
function ativarGPS(){
  if(!navigator.geolocation) return alert('GPS nÃ£o suportado');

  navigator.geolocation.watchPosition(p=>{
    const latlng=[p.coords.latitude,p.coords.longitude];
    if(!gpsMarker){
      gpsMarker=L.circleMarker(latlng,{
        radius:8,color:'black',fillColor:'black',fillOpacity:1
      }).addTo(map);
    } else {
      gpsMarker.setLatLng(latlng);
    }
  },()=>alert('Erro GPS'),{enableHighAccuracy:true});

  falar('GPS ativado');
}

/* ================= ROTA ORS ================= */
async function rotaPara(dest){
  if(!gpsMarker) return alert('Ative o GPS');

  const o = gpsMarker.getLatLng();

  const r = await fetch(
    "https://api.openrouteservice.org/v2/directions/driving-car",
    {
      method:"POST",
      headers:{
        "Authorization":ORS_KEY,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        coordinates:[
          [o.lng,o.lat],
          [dest.lng,dest.lat]
        ]
      })
    }
  );

  const d = await r.json();
  const pts = d.features[0].geometry.coordinates.map(c=>[c[1],c[0]]);

  if(rotaLinha) map.removeLayer(rotaLinha);
  rotaLinha = L.polyline(pts,{color:'blue',weight:6}).addTo(map);
}

/* ================= PRÃ“XIMA ================= */
async function proximaEntrega(){
  const p = entregas.find(e=>e.status==='pendente');
  if(!p) return falar('Todas entregas concluÃ­das');
  await rotaPara({lat:p.latlng.lat,lng:p.latlng.lng});
  falar('Rota traÃ§ada');
}

/* ================= STATUS ================= */
function entregar(i){
  entregas[i].status='entregue';
  salvar();
  atualizarLista();
}

function apagar(i){
  map.removeLayer(entregas[i].marker);
  entregas.splice(i,1);
  salvar();
  atualizarLista();
}

function limparTudo(){
  if(!confirm('Apagar tudo?')) return;
  entregas.forEach(e=>map.removeLayer(e.marker));
  entregas=[];
  salvar();
  atualizarLista();
  if(rotaLinha) map.removeLayer(rotaLinha);
}

/* ================= INIT ÃšNICO ================= */
window.addEventListener('load',()=>{
  entregas.forEach(criarMarker);
  atualizarLista();
  setTimeout(()=>map.invalidateSize(),500);
});
</script>

</body>
</html>
