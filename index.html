<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ponto Exato â€“ NavegaÃ§Ã£o de Entregas</title>

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#0d47a1;color:#fff;padding:12px;text-align:center}
#map{height:60vh}
.controls{padding:8px;display:flex;flex-wrap:wrap;gap:6px}
button,select{padding:14px;font-size:16px;border:none;border-radius:10px}
.btn{background:#1976d2;color:#fff}
.btn-ok{background:#2e7d32}
.btn-warn{background:#ef6c00}
.btn-del{background:#616161}
.entregas{background:#fff;max-height:30vh;overflow:auto;padding:8px}
.entrega{border-bottom:1px solid #ddd;padding:6px;font-size:13px}
.entrega.entregue{text-decoration:line-through;color:green}
</style>
</head>

<body>

<header>ğŸ“¦ Ponto Exato â€“ NavegaÃ§Ã£o</header>

<div id="map"></div>

<div class="controls">
  <button class="btn" onclick="adicionarEntrega()">ğŸ“ Adicionar</button>
  <button class="btn" onclick="buscarEndereco()">ğŸ” Buscar</button>
  <button class="btn-ok" onclick="iniciarRota()">ğŸš¦ Iniciar</button>
  <button class="btn-warn" onclick="proximaEntrega()">â¡ PrÃ³xima</button>
  <button class="btn" onclick="ativarGPS()">ğŸ“¡ GPS</button>

  <select id="transporte" onchange="alterarTransporte()">
    <option value="driving-car">ğŸš— Carro</option>
    <option value="driving-motorcycle">ğŸ Moto</option>
    <option value="cycling-regular">ğŸš² Bike</option>
    <option value="foot-walking">ğŸš¶ A pÃ©</option>
  </select>

  <button class="btn-del" onclick="limparTudo()">ğŸ—‘ Limpar</button>
</div>

<div class="entregas" id="lista"></div>

<script>
  /* ====== BLOQUEIO POR DISPOSITIVO ====== */
  
  // gera ou recupera ID Ãºnico do dispositivo
  function getDeviceId(){
    let id = localStorage.getItem("device_id");
    if(!id){
      id = 'dev-' + Math.random().toString(36).substr(2,9);
      localStorage.setItem("device_id", id);
    }
    return id;
  }
  
  // lista de dispositivos liberados (VOCÃŠ edita)
  const DISPOSITIVOS_LIBERADOS = [
    // EXEMPLO:
    // "dev-zuibh78qj"
  ];
  
  // verifica acesso
  (function verificarAcesso(){
    const id = getDeviceId();
  
    if(!DISPOSITIVOS_LIBERADOS.includes(id)){
      document.body.innerHTML = `
        <div style="
          height:100vh;
          display:flex;
          flex-direction:column;
          align-items:center;
          justify-content:center;
          font-family:Arial;
          text-align:center;
          background:#f2f2f2;
        ">
          <h2>ğŸ”’ Acesso bloqueado</h2>
          <p>Este aplicativo estÃ¡ vinculado a um Ãºnico dispositivo.</p>
          <p><strong>ID do dispositivo:</strong><br>${id}</p>
          <p>Envie este cÃ³digo para liberaÃ§Ã£o.</p>
        </div>
      `;
      throw new Error("Dispositivo nÃ£o autorizado");
    }
  })();
  </script>
  
<script>
  
// ================= CONFIG =================
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImU3ZGJlNTI2MDgwMTRiZmZiYzFlOTBmMzJkZmIxNmRiIiwiaCI6Im11cm11cjY0In0="; // â† COLE AQUI
const STORAGE_KEY = "ponto_exato_entregas";

// ================= MAPA =================
let map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© OpenStreetMap'
}).addTo(map);

// ================= ESTADO =================
let entregas = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let rotaLinha = null;
let gpsMarker = null;
let gpsWatch = null;
let transporte = 'driving-car';

// ================= VOZ =================
function falar(texto){
  let msg = new SpeechSynthesisUtterance(texto);
  msg.lang = "pt-BR";
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

// ================= STORAGE =================
function salvar(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entregas));
}

// ================= MARKERS =================
function criarMarker(e){
  e.marker = L.marker(e.latlng).addTo(map);
  e.marker.on('click',()=>{
    map.setView(e.latlng,18);
  });
}

// ================= LISTA =================
function atualizarLista(){
  let lista = document.getElementById('lista');
  lista.innerHTML = "";
  entregas.forEach((e,i)=>{
    let d = document.createElement('div');
    d.className = "entrega " + (e.status==="entregue"?"entregue":"");
    d.innerHTML = `
      ${i+1}. ${e.nome}<br>
      <button onclick="entregue(${i})">âœ…</button>
      <button onclick="desmarcar(${i})">ğŸ”„</button>
      <button onclick="apagar(${i})">ğŸ—‘</button>
    `;
    lista.appendChild(d);
  });
}

// ================= ROTA =================
async function desenharRota(destino){
  if(!gpsMarker) return;

  if(rotaLinha){
    map.removeLayer(rotaLinha);
    rotaLinha = null;
  }

  let origem = gpsMarker.getLatLng();

  let res = await fetch("https://api.openrouteservice.org/v2/directions/"+transporte,{
    method:"POST",
    headers:{
      "Authorization":ORS_KEY,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      coordinates:[
        [origem.lng, origem.lat],
        [destino.lng, destino.lat]
      ]
    })
  });

  let data = await res.json();
  let coords = data.features[0].geometry.coordinates.map(c=>[c[1],c[0]]);

  rotaLinha = L.polyline(coords,{color:'blue',weight:5}).addTo(map);
}

// ================= GPS =================
function ativarGPS(){
  if(!navigator.geolocation) return alert("GPS nÃ£o suportado");

  if(gpsWatch) navigator.geolocation.clearWatch(gpsWatch);

  const gpsIcon = L.divIcon({
    className: '',
    html: '<div style="width:16px;height:16px;background:#000;border-radius:50%;border:2px solid #fff"></div>',
    iconSize: [16,16],
    iconAnchor: [8,8]
  });

  gpsWatch = navigator.geolocation.watchPosition(pos=>{
    let latlng = [pos.coords.latitude, pos.coords.longitude];

    if(!gpsMarker){
      gpsMarker = L.marker(latlng,{icon:gpsIcon}).addTo(map);
    }else{
      gpsMarker.setLatLng(latlng);
    }

    map.setView(latlng,17);

  }, err => alert("Erro ao obter GPS"), {
    enableHighAccuracy:true,
    maximumAge:1000
  });

  falar("GPS ativado");
}


// ================= FLUXO =================
function iniciarRota(){
  let prox = entregas.find(e=>e.status==="pendente");
  if(!prox) return alert("Nenhuma entrega pendente");

  desenharRota(L.latLng(prox.latlng));
  falar("Rota iniciada");
}

function proximaEntrega(){
  iniciarRota();
  falar("PrÃ³xima entrega");
}

function entregue(i){
  entregas[i].status="entregue";
  salvar();
  atualizarLista();
  iniciarRota();
  falar("Entrega concluÃ­da");
}

function desmarcar(i){
  entregas[i].status="pendente";
  salvar();
  atualizarLista();
}

function apagar(i){
  map.removeLayer(entregas[i].marker);
  entregas.splice(i,1);
  salvar();
  atualizarLista();
  iniciarRota();
}

// ================= AÃ‡Ã•ES =================
function adicionarEntrega(){
  alert("Clique no mapa");
  map.once('click',e=>{
    let nome = prompt("DescriÃ§Ã£o");
    if(!nome) return;
    let ent={nome,latlng:e.latlng,status:"pendente"};
    entregas.push(ent);
    criarMarker(ent);
    salvar();
    atualizarLista();
  });
}

async function buscarEndereco(){
  let texto = prompt("Digite o endereÃ§o ou CEP:");
  if(!texto) return;

  let cep = texto.replace(/\D/g,'');
  let query = texto;

  // Se for CEP
  if(cep.length === 8){
    let rCep = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
    let dCep = await rCep.json();
    if(dCep.erro) return alert("CEP nÃ£o encontrado");

    query = `${dCep.logradouro}, ${dCep.localidade} - ${dCep.uf}`;
  }

  let r = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`
  );
  let d = await r.json();
  if(!d.length) return alert("Local nÃ£o encontrado");

  let latlng = [parseFloat(d[0].lat), parseFloat(d[0].lon)];
  map.setView(latlng,18);

  if(confirm("Adicionar entrega aqui?")){
    let ent = { nome: query, latlng, status:"pendente" };
    entregas.push(ent);
    criarMarker(ent);
    salvar();
    atualizarLista();
    falar("Entrega adicionada");
  }
}


function limparTudo(){
  if(!confirm("Apagar tudo?")) return;
  entregas.forEach(e=>map.removeLayer(e.marker));
  entregas=[];
  salvar();
  atualizarLista();
  if(rotaLinha) map.removeLayer(rotaLinha);
}

// ================= INIT =================
entregas.forEach(criarMarker);
atualizarLista();
ativarGPS();

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>
